
<div style="min-width:200px">
	<p>Switch to Amazon:</p>
	<ul id="switcher"></ul>
</div>

<script>

function AmazonStoreSwitcher() {

	this.element = document.getElementById('switcher');

	this.stores = [
		{
			name: 'Canada',
			domain: '.ca'
		}, {
			name: 'China',
			domain: '.cn'
		}, {
			name: 'France',
			domain: '.fr'
		}, {
			name: 'Germany',
			domain: '.de'
		}, {
			name: 'Italy',
			domain: '.it'
		}, {
			name: 'Japan',
			domain: '.co.jp'
		}, {
			name: 'Spain',
			domain: '.es'
		}, {
			name: 'UK',
			domain: '.co.uk'
		}, {
			name: 'USA',
			domain: '.com'
		}
	];

	this.render();
}

AmazonStoreSwitcher.prototype.render = function () {

	var match, self = this;

	this.element.innerHTML = '';

	chrome.tabs.getSelected(null, function (tab) {

		self.tab = tab;

		match = tab.url.match(/amazon.*?\/([d|g]p)\/(product\/)?([A-Z|0-9]+)/);

		if (match === null) {
			return;
		}

		var filler = (typeof match[2] === 'string') ? match[2] : '';

		self.stores.forEach(function(store) {
			store.url = 'http://www.amazon' + store.domain + '/' + match[1] + '/' + filler + match[3];
			self.addButton(store);
		});
	});
}

AmazonStoreSwitcher.prototype.appendButton = function (store) {

	var self = this,
		li = document.createElement('li'),
		a = document.createElement('a'),
		text = document.createTextNode(store.name);

	if (store.domain === this.tab.url.match(/http:\/\/www.amazon([\.|a-z]+)\//)[1]) {
		li.appendChild(text);
	} else {
		a.appendChild(text);
		a.setAttribute('data-domain', store.domain);
		a.href = 'javasript:void();';
		a.onclick = function () {
			chrome.tabs.update(self.tab.id, { url: store.url });
			self.render();
		};

		li.appendChild(a);
	}

	this.element.appendChild(li);
};

AmazonStoreSwitcher.prototype.addButton = function (store) {

	var req,
		url = window.localStorage[store.url],
		self = this;

	if (typeof url === 'string') {
		this.appendButton(store);
	} else {
		req = new XMLHttpRequest(),
		req.open('GET', store.url, true);
		req.onreadystatechange = function (response) {
			if (req.readyState === 4) {
				if (req.status === 200) {
					window.localStorage[store.url] = store.url;
					self.appendButton(store);
				}
			}
		};
		req.send('');
	}
};

var Switcher = new AmazonStoreSwitcher();

</script>
