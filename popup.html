
<div style="min-width:200px">
	<p>Switch to Amazon:</p>
	<ul id="switcher"></ul>
</div>

<script>

function AmazonStoreSwitcher() {

	var self = this;

	if (!window.localStorage.urls) {
		window.localStorage.urls = [];
	}

	this.element = document.getElementById('switcher');

	this.stores = [
		{
			name: "USA",
			domain: ".com"
		}, {
			name: "UK",
			domain: ".co.uk"
		}, {
			name: "Canada",
			domain: ".ca"
		}, {
			name: "Spain",
			domain: ".es"
		}, {
			name: "Japan",
			domain: ".co.jp"
		}
	];

	chrome.tabs.getSelected(null, function (tab) {

		self.tab = tab;

		self.stores.forEach(function(store) {
			store.url = tab.url.replace(/amazon\.[a-z|\.]+/, 'amazon' + store.domain);
			self.addButton(store);
		});
	});
}

AmazonStoreSwitcher.prototype.appendButton = function (store) {

	var self = this,
		li = document.createElement('li'),
		a = document.createElement('a');

	a.appendChild(document.createTextNode(store.name));
	a.setAttribute('data-domain', store.domain);
	a.href = "javasript:void();";
	a.onclick = function () {
		chrome.tabs.update(self.tab.id, { url: store.url });
	};

	li.appendChild(a);

	this.element.appendChild(li);
};

AmazonStoreSwitcher.prototype.addButton = function (store) {

	var req,
		url = window.localStorage[store.url],
		self = this;

	if (typeof url === 'string') {
		this.appendButton(store);
	} else {
		req = new XMLHttpRequest(),
		req.open('GET', store.url, true);
		req.onreadystatechange = function (response) {
			if (req.readyState === 4) {
				if (req.status === 200) {
					window.localStorage[store.url] = store.url;
					self.appendButton(store);
				}
			}
		};
		req.send('');
	}
};

var Switcher = new AmazonStoreSwitcher();

</script>
